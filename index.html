<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <script src="//www.kosmosnimki.ru/lib/geomixer_1.3/geomixer-src.js?key=E5FB6CCB5D23B5E119D2F1B26BCC57BD"></script>
    <link href="//www.kosmosnimki.ru/lib/geomixer_1.3/geomixer.css" rel="stylesheet" />

    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0px;
        }
    </style>
	<title>GeoMixer API - примеры</title>
    <script src="./src/L.ImageTransformWebGL.js"></script>
</head>

<body>
	<div id="map"></div>

<script>
	var map = new L.Map('map', {
		center: new L.LatLng(56, 137.23),
		zoom: 8
	});

	var layersControl = L.control.layers({
		Google: L.tileLayer('//mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'),
		Map: L.tileLayer.Mercator('//vec03.maps.yandex.net/tiles?l=map&v=17.09.21-1&x={x}&y={y}&z={z}&scale=1&lang=ru_RU', {
			maxZoom: 21,
			maxNativeZoom: 17
		}).addTo(map)
	}).addTo(map);
	
	var anchors = [
			L.latLng([55.613245, 136.59558]),	// top-left
			L.latLng([55.613245, 137.87820]),	// top-right
			L.latLng([56.344192, 137.87820]),	// bottom-right
			L.latLng([56.344192, 136.59558])	// bottom-left
		],
		clip = [
			L.latLng([56.301281, 136.90579]),	// top-left
			L.latLng([56.150009, 137.83902]),	// top-right
			L.latLng([55.639533, 137.53169]),	// bottom-right
			L.latLng([55.788635, 136.60979])	// bottom-left
		];

	var imageTransform = new L.ImageTransformWebGL('./examples/img/image.jpg', anchors,
		{
			clip: clip,
			opacity: 0.5,
			disableSetClip: false
		});

	var drawClip;
	var drawAnchors = new L.GmxDrawing.Feature(map.gmxDrawing,
		L.polygon(anchors, {color: 'red'}),
		{editable: true, disableAddPoints: true, maxPoints: 4, type: 'Polygon', lineStyle: {color: 'blue'}, pointStyle: {shape: 'box'}}
	).on('edit', function() {
		var latlngs = drawAnchors.getLayers()[0].points.getLatLngs()[0];
		imageTransform.setOpacity(0.5);
		imageTransform.setAnchors(latlngs);
        drawClip.rings[0].ring.setLatLngs(imageTransform.getClip());
	})
	.on('editstop', function() {
		imageTransform.setOpacity(1);
	});

	var overlay = L.featureGroup([
		imageTransform,
		drawAnchors
	]).addTo(map);
	layersControl.addOverlay(overlay, 'imageTransform');

	if (imageTransform.options.clip) {
		drawClip = new L.GmxDrawing.Feature(map.gmxDrawing, L.polygon(clip), {editable: true, type: 'Polygon', lineStyle: {color: 'red'}, pointStyle: {color: 'red'}});
		drawClip.on('edit', function() {
			imageTransform.setClip(drawClip.getLayers()[0].points.getLatLngs()[0]);
		});
		overlay.addLayer(drawClip);
	}
</script>

</body>
</html>